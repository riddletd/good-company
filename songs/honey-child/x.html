<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chords & Lyrics</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #f5f5dc;
        color: #333;
      }

      .song-container {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Print styles for 8.5x11 paper */
      @media print {
        body {
          margin: 0;
          padding: 0;
          background-color: white;
        }

        .song-container {
          width: 8.5in;
          margin: 0;
          padding: 0;
          box-shadow: none;
          border-radius: 0;
        }

        @page {
          size: 8.5in 11in;
          margin: 1in 0.75in;
        }

        .section {
          page-break-inside: avoid;
        }

        h1,
        .artist {
          page-break-after: avoid;
        }
      }

      h1 {
        text-align: center;
        color: #2c5f2d;
        margin-bottom: 10px;
      }

      .artist {
        text-align: center;
        color: #666;
        font-style: italic;
      }

      .section {
        margin-bottom: 25px;
      }

      .section-title {
        font-weight: bold;
        color: #2c5f2d;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-size: 0.9em;
      }

      .line {
        display: flex;
        margin-bottom: 5px;
        position: relative;
      }

      .chord-lyric {
        display: flex;
        flex-direction: column;
      }

      .space {
        margin-left: 10px;
      }

      .pad-space {
        padding-left: 10px;
      }

      .chords {
        color: #d9534f;
        font-weight: bold;
        font-size: 0.95em;
        letter-spacing: 0.5px;
        line-height: 1.5;
        min-height: 1.5em;
      }

      .lyrics {
        color: #333;
        line-height: 1.5;
        font-size: 1em;
      }

      .chord {
        display: inline-block;
        min-width: 20px;
      }

      /* Optional: Add some spacing for better readability */
      .spacer {
        height: 15px;
      }

      table {
        margin-bottom: 50px;
        font-size: 0.9em;
        color: #666;
      }

      td {
        min-width: 75px;
      }

      td button {
        color: #333;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.85em;
        height: 20px;
        width: 20px;
      }

      .controls button:hover {
        background-color: #f0f0f0;
      }

      .audio {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2d0px;
        margin-bottom: 30px;
      }

      @media print {
        .audio {
          display: none;
        }

        table {
          margin-top: 30px;
        }

        td button {
          display: none;
        }

        h1 {
          margin-top: 0;
        }

        .section {
          page-break-inside: avoid;
        }

        h1,
        .artist {
          page-break-after: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="song-container">
      <h1 data-key="C">Honey Child</h1>
      <div class="artist">Bad Company</div>

      <div class="audio">
        <audio controls loop preload="metadata">
          <source src="master.mp3" type="audio/mpeg" />
          Your browser doesn't support audio.
        </audio>
      </div>

      <table>
        <tr>
          <td>Original Key:</td>
          <td id="originalKey" class="pad-space"><span id="originalKeyDisplay">C#</span> (<span id="originalKeyDistance">-2</span>)</td>
        </tr>
        <tr>
          <td>Key:</td>
          <td id="currentKey" class="pad-space">C (<span id="currentKeyDistance">0</span>)</td>
          <td>
            <button onclick="transposeDown()">-</button>
            <button onclick="transposeUp()">+</button>
          </td>
        </tr>
        <tr>
          <td>Bpm:</td>
          <td class="pad-space">~109</td>
        </tr>
        <tr>
          <td>Time Sign:</td>
          <td class="pad-space">4/4</td>
        </tr>
      </table>

      <div class="section">
        <div class="section-title">Verse 1 (16b) (F4 C4 G8)</div>

        <div class="line">
          <div class="chord-lyric">
            <div class="chords"></div>
            <div class="lyrics">In the be</div>
          </div>
          <div class="chord-lyric">
            <div class="chords">F 4</div>
            <div class="lyrics">ginning</div>
          </div>
          <div class="chord-lyric">
            <div class="space chords">C 4</div>
            <div class="lyrics"></div>
          </div>
        </div>

        <div class="line">
          <div class="chord-lyric">
            <div class="chords"></div>
            <div class="lyrics">I believed every w</div>
          </div>
          <div class="chord-lyric">
            <div class="chords">G 8</div>
            <div class="lyrics">ord that you said</div>
          </div>
        </div>

        <div class="line">
          <div class="chord-lyric">
            <div class="chords">F 4</div>
            <div class="lyrics"></div>
          </div>
          <div class="space chord-lyric">
            <div class="space chords"></div>
            <div class="lyrics">Now that you're g</div>
          </div>
          <div class="chord-lyric">
            <div class="chords">C</div>
            <div class="lyrics">one.</div>
          </div>
        </div>

        <div class="line">
          <div class="chord-lyric">
            <div class="chords"></div>
            <div class="lyrics">My world is in</div>
          </div>
          <div class="space chord-lyric">
            <div class="chords">G</div>
            <div class="lyrics">shreds.</div>
          </div>
        </div>

        <div class="line">
          <div class="chord-lyric">
            <div class="chords"></div>
            <div class="lyrics">Oh, you</div>
          </div>
          <div class="space chord-lyric">
            <div class="chords">F</div>
            <div class="lyrics">loved me and left me</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const chordMap = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
      const minorChordMap = ["Cm", "C#m", "Dm", "D#m", "Em", "Fm", "F#m", "Gm", "G#m", "Am", "A#m", "Bm"];

      let currentTranspose = 0;
      const originalKey = "C";
      const originalOriginalKey = document.getElementById("originalKeyDisplay").textContent; // The actual original key before any transposition

      // Calculate the initial distance from the original-original key
      function getKeyIndex(key) {
        const normalizedKey = key.replace("Db", "C#").replace("Eb", "D#").replace("Gb", "F#").replace("Ab", "G#").replace("Bb", "A#");
        return chordMap.indexOf(normalizedKey);
      }

      function calculateDistance(fromKey, toKey) {
        const fromIndex = getKeyIndex(fromKey);
        const toIndex = getKeyIndex(toKey);

        let distance = toIndex - fromIndex;

        // Normalize to +/- 6 semitones
        if (distance > 6) {
          distance = distance - 12;
        } else if (distance < -6) {
          distance = distance + 12;
        }

        return distance;
      }

      const initialDistance = calculateDistance(originalOriginalKey, originalKey);

      function transposeChord(chord, steps) {
        // Handle empty chords
        if (!chord || chord.trim() === "") return chord;

        // Check if it's a minor chord
        const isMinor = chord.includes("m") && !chord.includes("maj");

        // Extract the root note (handle sharps and flats)
        let root = chord.match(/^[A-G][#b]?/);
        if (!root) return chord;
        root = root[0];

        // Get the suffix (everything after the root)
        const suffix = chord.substring(root.length);

        // Convert flats to sharps for easier processing
        root = root.replace("Db", "C#").replace("Eb", "D#").replace("Gb", "F#").replace("Ab", "G#").replace("Bb", "A#");

        // Find the chord in the appropriate map
        let map = isMinor ? minorChordMap : chordMap;
        let searchRoot = isMinor ? root + "m" : root;
        let index = map.indexOf(searchRoot);

        if (index === -1) {
          // If not found in minor map, try major map
          if (isMinor) {
            searchRoot = root;
            map = chordMap;
            index = map.indexOf(searchRoot);
          }
          if (index === -1) return chord;
        }

        // Transpose
        let newIndex = (index + steps) % 12;
        if (newIndex < 0) newIndex += 12;

        let newChord = map[newIndex];

        // If we found it in major map but it's a minor chord, add 'm' back
        if (isMinor && !newChord.includes("m")) {
          newChord = newChord + "m";
        }

        // Remove the 'm' from the root if it was added during search
        if (isMinor && suffix.startsWith("m")) {
          newChord = newChord.replace("m", "");
        }

        return newChord + suffix;
      }

      function transposeUp() {
        currentTranspose = (currentTranspose + 1) % 12;
        updateChords();
      }

      function transposeDown() {
        currentTranspose = (currentTranspose - 1) % 12;
        updateChords();
      }

      function updateChords() {
        const chordElements = document.querySelectorAll(".chords");
        chordElements.forEach((element) => {
          const originalChord = element.getAttribute("data-original") || element.textContent;
          if (!element.getAttribute("data-original")) {
            element.setAttribute("data-original", originalChord);
          }
          element.textContent = transposeChord(originalChord, currentTranspose);
        });

        // Update the current key display
        const newKey = transposeChord(originalKey, currentTranspose);
        const totalDistance = initialDistance + currentTranspose;

        // Normalize to +/- 6 semitones for display
        let displayDistance = totalDistance;
        if (displayDistance > 6) {
          displayDistance = displayDistance - 12;
        } else if (displayDistance < -6) {
          displayDistance = displayDistance + 12;
        }

        const sign = displayDistance > 0 ? "+" : "";
        const opp_sign = displayDistance === 0 ? "" : displayDistance > 0 ? "-" : "+";

        document.getElementById("currentKey").innerHTML = `${newKey}`;
        document.getElementById("originalKey").innerHTML = `${originalOriginalKey} (<span id="originalKeyDistance">${opp_sign}${Math.abs(displayDistance)}</span>)`;
      }

      // Initialize the display on page load
      updateChords();
    </script>
  </body>
</html>
